<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>äº”å­æ£‹æ¸¸æˆ - ç®¡ç†å‘˜ç›‘æ§é¢æ¿</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        padding: 20px;
      }

      .stat-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        border-left: 4px solid #007bff;
      }

      .stat-card.active {
        border-left-color: #28a745;
      }

      .stat-card.games {
        border-left-color: #ffc107;
      }

      .stat-card.users {
        border-left-color: #17a2b8;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
        font-size: 0.9em;
      }

      .section {
        margin: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
      }

      .section-header {
        background: #e9ecef;
        padding: 15px 20px;
        font-weight: bold;
        color: #333;
        border-bottom: 1px solid #dee2e6;
      }

      .section-content {
        padding: 20px;
      }

      .user-list {
        display: grid;
        gap: 10px;
      }

      .user-item {
        display: grid;
        grid-template-columns: 1fr 80px 80px 80px 150px;
        gap: 15px;
        padding: 10px;
        background: white;
        border-radius: 6px;
        align-items: center;
        font-size: 0.9em;
      }

      .user-item.header {
        background: #e9ecef;
        font-weight: bold;
      }

      .refresh-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 20px;
      }

      .refresh-btn:hover {
        background: #218838;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin: 20px;
      }

      .time-info {
        text-align: center;
        color: #666;
        font-size: 0.9em;
        padding: 10px;
        background: #e9ecef;
      }

      .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
      }

      .pagination-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .pagination-btn:hover {
        background: #0056b3;
      }

      .pagination-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .pagination-info {
        color: #666;
        font-size: 14px;
      }

      .user-limit-control {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
      }

      .user-limit-control select {
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      @media (max-width: 768px) {
        .stats-grid {
          grid-template-columns: 1fr;
        }

        .user-item {
          grid-template-columns: 1fr;
          gap: 5px;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ® äº”å­æ£‹æ¸¸æˆç›‘æ§é¢æ¿</h1>
        <p>å®æ—¶æŸ¥çœ‹ç”¨æˆ·æ´»åŠ¨å’Œæ¸¸æˆç»Ÿè®¡</p>
      </div>

      <button class="refresh-btn" onclick="loadStats()">ğŸ”„ åˆ·æ–°æ•°æ®</button>

      <div id="loading" class="loading">
        <div>ğŸ“Š æ­£åœ¨åŠ è½½æ•°æ®...</div>
      </div>

      <div id="error" class="error" style="display: none"></div>

      <div id="content" style="display: none">
        <!-- åŸºç¡€ç»Ÿè®¡ -->
        <div class="stats-grid">
          <div class="stat-card users">
            <div class="stat-number" id="totalUsers">-</div>
            <div class="stat-label">Piç”¨æˆ·æ€»æ•°</div>
          </div>
          <div class="stat-card active">
            <div class="stat-number" id="activeUsers">-</div>
            <div class="stat-label">å·²æ¸¸æˆç”¨æˆ·</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="recentActiveUsers">-</div>
            <div class="stat-label">24å°æ—¶å†…æ´»è·ƒ</div>
          </div>
          <div class="stat-card games">
            <div class="stat-number" id="totalGames">-</div>
            <div class="stat-label">æ€»æ¸¸æˆå±€æ•°</div>
          </div>
        </div>

        <!-- ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ -->
        <div class="section">
          <div class="section-header">ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨</div>
          <div class="section-content">
            <div class="user-limit-control">
              <label>æ¯é¡µæ˜¾ç¤º:</label>
              <select id="userLimit" onchange="changeUserLimit()">
                <option value="20">20ä¸ªç”¨æˆ·</option>
                <option value="50" selected>50ä¸ªç”¨æˆ·</option>
                <option value="100">100ä¸ªç”¨æˆ·</option>
                <option value="all">å…¨éƒ¨ç”¨æˆ·</option>
              </select>
            </div>

            <div class="pagination-controls" id="paginationTop">
              <button
                class="pagination-btn"
                id="prevBtn"
                onclick="changePage(-1)"
              >
                ä¸Šä¸€é¡µ
              </button>
              <span class="pagination-info" id="pageInfo"
                >ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span
              >
              <button
                class="pagination-btn"
                id="nextBtn"
                onclick="changePage(1)"
              >
                ä¸‹ä¸€é¡µ
              </button>
            </div>

            <div class="user-list">
              <div class="user-item header">
                <div>ç”¨æˆ·å</div>
                <div>æ¸¸æˆæ•°</div>
                <div>èƒœåœº</div>
                <div>èƒœç‡</div>
                <div>æœ€åç™»å½•</div>
              </div>
              <div id="paginatedUsersList"></div>
            </div>

            <div class="pagination-controls" id="paginationBottom">
              <button class="pagination-btn" onclick="changePage(-1)">
                ä¸Šä¸€é¡µ
              </button>
              <span class="pagination-info" id="pageInfoBottom"
                >ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span
              >
              <button class="pagination-btn" onclick="changePage(1)">
                ä¸‹ä¸€é¡µ
              </button>
            </div>
          </div>
        </div>

        <!-- æœ€è¿‘ç™»å½•ç”¨æˆ· -->
        <div class="section">
          <div class="section-header">ğŸ“± æœ€è¿‘ç™»å½•ç”¨æˆ· (æœ€æ–°10ä¸ª)</div>
          <div class="section-content">
            <div class="user-list">
              <div class="user-item header">
                <div>ç”¨æˆ·å</div>
                <div>æ¸¸æˆæ•°</div>
                <div>èƒœåœº</div>
                <div>èƒœç‡</div>
                <div>æœ€åç™»å½•</div>
              </div>
              <div id="recentUsersList"></div>
            </div>
          </div>
        </div>

        <!-- æ´»è·ƒç”¨æˆ·æ’è¡Œ -->
        <div class="section">
          <div class="section-header">ğŸ† æ´»è·ƒç”¨æˆ·æ’è¡Œ (æŒ‰æ¸¸æˆå±€æ•°)</div>
          <div class="section-content">
            <div class="user-list">
              <div class="user-item header">
                <div>ç”¨æˆ·å</div>
                <div>æ¸¸æˆæ•°</div>
                <div>èƒœåœº</div>
                <div>èƒœç‡</div>
                <div>æœ€åç™»å½•</div>
              </div>
              <div id="topActiveUsersList"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="time-info" id="timeInfo"></div>
    </div>

    <script>
      // APIé…ç½®
      const API_BASE_URL =
        window.location.hostname === "localhost"
          ? "http://localhost:3001"
          : "http://47.82.3.211:3001";

      // åˆ†é¡µçŠ¶æ€
      let currentPage = 1;
      let currentLimit = 50;
      let totalPages = 1;
      let currentStats = null;

      // åŠ è½½ç»Ÿè®¡æ•°æ®
      async function loadStats(page = currentPage, limit = currentLimit) {
        const loading = document.getElementById("loading");
        const error = document.getElementById("error");
        const content = document.getElementById("content");

        loading.style.display = "block";
        error.style.display = "none";
        content.style.display = "none";

        try {
          // æ„å»ºæŸ¥è¯¢å‚æ•°
          const params = new URLSearchParams({
            page: page,
            limit: limit === "all" ? "all" : limit,
          });

          // å…ˆå°è¯•æ–°çš„ç®¡ç†å‘˜æ¥å£
          let response = await fetch(
            `${API_BASE_URL}/api/admin/stats?${params}`
          );

          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              currentStats = data.stats;
              currentPage = page;
              currentLimit = limit;
              displayStats(data.stats);
              content.style.display = "block";
              return;
            }
          }

          // å¦‚æœç®¡ç†å‘˜æ¥å£ä¸å¯ç”¨ï¼Œä½¿ç”¨æ’è¡Œæ¦œæ¥å£è·å–æ•°æ®
          console.log("ç®¡ç†å‘˜æ¥å£ä¸å¯ç”¨ï¼Œä½¿ç”¨æ’è¡Œæ¦œæ¥å£...");
          response = await fetch(`${API_BASE_URL}/api/leaderboard`);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const leaderboardData = await response.json();

          if (leaderboardData.success) {
            // ä»æ’è¡Œæ¦œæ•°æ®æ„é€ ç»Ÿè®¡ä¿¡æ¯
            const mockStats = createStatsFromLeaderboard(
              leaderboardData.leaderboard
            );
            displayStats(mockStats);
            content.style.display = "block";
          } else {
            throw new Error(leaderboardData.message || "è·å–æ•°æ®å¤±è´¥");
          }
        } catch (err) {
          console.error("åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:", err);
          error.textContent = `âŒ åŠ è½½å¤±è´¥: ${err.message}`;
          error.style.display = "block";
        } finally {
          loading.style.display = "none";
        }
      }

      // ä»æ’è¡Œæ¦œæ•°æ®åˆ›å»ºç»Ÿè®¡ä¿¡æ¯
      function createStatsFromLeaderboard(leaderboard) {
        const now = new Date();

        return {
          totalUsers: leaderboard.length,
          activeUsers: leaderboard.filter((user) => user.totalGames > 0).length,
          recentActiveUsers: leaderboard.length, // å‡è®¾æ’è¡Œæ¦œä¸­çš„éƒ½æ˜¯æ´»è·ƒç”¨æˆ·
          totalGames: leaderboard.reduce(
            (sum, user) => sum + user.totalGames,
            0
          ),
          newUsersToday: 0, // æ— æ³•ä»æ’è¡Œæ¦œè·å–

          recentUsers: leaderboard.slice(0, 10).map((user) => ({
            id: "user_***",
            username: user.username,
            totalGames: user.totalGames,
            wins: user.wins,
            winRate: user.winRate,
            lastLoginAt: now.toISOString(), // æ¨¡æ‹Ÿæ•°æ®
            createdAt: now.toISOString(),
          })),

          topActiveUsers: leaderboard
            .sort((a, b) => b.totalGames - a.totalGames)
            .slice(0, 10)
            .map((user) => ({
              id: "user_***",
              username: user.username,
              totalGames: user.totalGames,
              wins: user.wins,
              winRate: user.winRate,
              lastLoginAt: now.toISOString(),
            })),

          serverTime: now.toISOString(),
          dataLastUpdated: now.toISOString(),
        };
      }

      // åˆ†é¡µæ§åˆ¶å‡½æ•°
      function changePage(direction) {
        const newPage = currentPage + direction;
        if (newPage >= 1 && newPage <= totalPages) {
          loadStats(newPage, currentLimit);
        }
      }

      function changeUserLimit() {
        const select = document.getElementById("userLimit");
        const newLimit = select.value;
        currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        loadStats(1, newLimit);
      }

      function updatePaginationControls(pagination) {
        if (!pagination) return;

        totalPages = pagination.totalPages;

        // æ›´æ–°é¡µé¢ä¿¡æ¯
        const pageInfo = `ç¬¬ ${pagination.currentPage} é¡µï¼Œå…± ${pagination.totalPages} é¡µ (æ€»è®¡ ${pagination.totalUsers} ä¸ªç”¨æˆ·)`;
        document.getElementById("pageInfo").textContent = pageInfo;
        document.getElementById("pageInfoBottom").textContent = pageInfo;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const prevBtns = document.querySelectorAll(
          ".pagination-btn:first-child"
        );
        const nextBtns = document.querySelectorAll(
          ".pagination-btn:last-child"
        );

        prevBtns.forEach((btn) => {
          btn.disabled = !pagination.hasPrevPage;
        });

        nextBtns.forEach((btn) => {
          btn.disabled = !pagination.hasNextPage;
        });
      }

      // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
      function displayStats(stats) {
        // åŸºç¡€ç»Ÿè®¡
        document.getElementById("totalUsers").textContent = stats.totalUsers;
        document.getElementById("activeUsers").textContent = stats.activeUsers;
        document.getElementById("recentActiveUsers").textContent =
          stats.recentActiveUsers;
        document.getElementById("totalGames").textContent = stats.totalGames;

        // æ›´æ–°åˆ†é¡µç”¨æˆ·åˆ—è¡¨
        if (stats.pagination) {
          updatePaginationControls(stats.pagination);
          const paginatedList = document.getElementById("paginatedUsersList");
          paginatedList.innerHTML = stats.pagination.users
            .map(
              (user) => `
                  <div class="user-item">
                      <div>${user.username}</div>
                      <div>${user.totalGames}</div>
                      <div>${user.wins}</div>
                      <div>${user.winRate}%</div>
                      <div>${formatTime(user.lastLoginAt)}</div>
                  </div>
              `
            )
            .join("");
        }

        // æœ€è¿‘ç™»å½•ç”¨æˆ·
        const recentList = document.getElementById("recentUsersList");
        recentList.innerHTML = stats.recentUsers
          .map(
            (user) => `
                <div class="user-item">
                    <div>${user.username}</div>
                    <div>${user.totalGames}</div>
                    <div>${user.wins}</div>
                    <div>${user.winRate}%</div>
                    <div>${formatTime(user.lastLoginAt)}</div>
                </div>
            `
          )
          .join("");

        // æ´»è·ƒç”¨æˆ·æ’è¡Œ
        const topList = document.getElementById("topActiveUsersList");
        topList.innerHTML = stats.topActiveUsers
          .map(
            (user) => `
                <div class="user-item">
                    <div>${user.username}</div>
                    <div>${user.totalGames}</div>
                    <div>${user.wins}</div>
                    <div>${user.winRate}%</div>
                    <div>${formatTime(user.lastLoginAt)}</div>
                </div>
            `
          )
          .join("");

        // æ›´æ–°æ—¶é—´ä¿¡æ¯
        document.getElementById(
          "timeInfo"
        ).textContent = `æ•°æ®æ›´æ–°æ—¶é—´: ${formatTime(stats.serverTime)}`;
      }

      // æ ¼å¼åŒ–æ—¶é—´
      function formatTime(timeString) {
        const date = new Date(timeString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffMins < 1) return "åˆšåˆš";
        if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
        if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
        if (diffDays < 7) return `${diffDays}å¤©å‰`;

        return date.toLocaleDateString("zh-CN", {
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
      document.addEventListener("DOMContentLoaded", loadStats);

      // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
      setInterval(loadStats, 30000);
    </script>
  </body>
</html>
