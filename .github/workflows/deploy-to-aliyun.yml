name: Deploy Backend to Aliyun

on:
  push:
    branches: [ main, master ]
    paths:
      - 'houduan/**'  # åªæœ‰åç«¯æ–‡ä»¶å˜åŒ–æ—¶æ‰è§¦å‘
      - '.github/workflows/deploy-to-aliyun.yml'  # å·¥ä½œæµæ–‡ä»¶å˜åŒ–æ—¶ä¹Ÿè§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: houduan/package-lock.json
        
    - name: å®‰è£…ä¾èµ–å¹¶æµ‹è¯•
      run: |
        cd houduan
        npm ci
        # npm test  # å¦‚æœæœ‰æµ‹è¯•çš„è¯
        
    - name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || 22 }}
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°é˜¿é‡Œäº‘..."
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /var/www/pi-gomoku
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git reset --hard origin/main
          git pull origin main
          
          # å®‰è£…åç«¯ä¾èµ–
          echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
          cd houduan
          npm install --production
          
          # é‡å¯åç«¯æœåŠ¡
          echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
          pm2 restart pi-gomoku-backend || pm2 start server.js --name pi-gomoku-backend
          
          # é‡è½½Nginx
          echo "ğŸ”„ é‡è½½Nginx..."
          nginx -s reload
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          pm2 status
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          
    - name: å¥åº·æ£€æŸ¥
      run: |
        echo "ğŸ¥ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 10
        
        # æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸
        if curl -f -s "http://${{ secrets.ALIYUN_HOST }}/api/health" > /dev/null; then
          echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
        
    - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.ALIYUN_HOST }}"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi
