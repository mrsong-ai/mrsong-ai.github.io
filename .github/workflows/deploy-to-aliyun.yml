name: Deploy Backend to Aliyun

on:
  push:
    branches: [ main, master ]
    paths:
      - 'houduan/**'  # åªæœ‰åç«¯æ–‡ä»¶å˜åŒ–æ—¶æ‰è§¦å‘
      - '.github/workflows/deploy-to-aliyun.yml'  # å·¥ä½œæµæ–‡ä»¶å˜åŒ–æ—¶ä¹Ÿè§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: houduan/package-lock.json
        
    - name: å®‰è£…ä¾èµ–å¹¶æµ‹è¯•
      run: |
        cd houduan
        npm ci
        # npm test  # å¦‚æœæœ‰æµ‹è¯•çš„è¯
        
    - name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT || 22 }}
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°é˜¿é‡Œäº‘..."

          # è®¾ç½®é”™è¯¯å¤„ç†
          set -e

          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /var/www/pi-gomoku

          # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "houduan" ]; then
            echo "ğŸ’¾ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
            cp -r houduan houduan.backup.$(date +%Y%m%d_%H%M%S) || true
          fi

          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git fetch origin
          git reset --hard origin/main
          git pull origin main

          # è¿›å…¥åç«¯ç›®å½•
          cd houduan

          # å¤åˆ¶ç”Ÿäº§ç¯å¢ƒé…ç½®
          echo "âš™ï¸ é…ç½®ç”Ÿäº§ç¯å¢ƒ..."
          if [ -f ".env.production" ]; then
            cp .env.production .env
          fi

          # å®‰è£…åç«¯ä¾èµ–
          echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
          npm ci --production --silent

          # åˆ›å»ºæ—¥å¿—ç›®å½•
          mkdir -p logs

          # è¿è¡Œéƒ¨ç½²å‰æ£€æŸ¥
          echo "ğŸ” è¿è¡Œéƒ¨ç½²å‰æ£€æŸ¥..."
          chmod +x pre-deploy-check.sh
          ./pre-deploy-check.sh || echo "âš ï¸ æ£€æŸ¥æœ‰è­¦å‘Šï¼Œç»§ç»­éƒ¨ç½²..."

          # é‡å¯åç«¯æœåŠ¡
          echo "ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
          pm2 restart pi-gomoku-backend || pm2 start ecosystem.config.js --env production

          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 5

          # æ›´æ–°Nginxé…ç½®ï¼ˆå¦‚æœæœ‰æ–°é…ç½®ï¼‰
          if [ -f "nginx-enhanced.conf" ]; then
            echo "ğŸ”„ æ›´æ–°Nginxé…ç½®..."
            sudo cp nginx-enhanced.conf /etc/nginx/conf.d/pi-gomoku.conf
            sudo nginx -t && sudo nginx -s reload
          fi

          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          pm2 status
          pm2 logs pi-gomoku-backend --lines 10 --nostream || true

          # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰
          echo "ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½..."
          ls -t houduan.backup.* 2>/dev/null | tail -n +4 | xargs rm -rf || true

          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          
    - name: å¥åº·æ£€æŸ¥
      run: |
        echo "ğŸ¥ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 10
        
        # æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸
        if curl -f -s "http://${{ secrets.ALIYUN_HOST }}/api/health" > /dev/null; then
          echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
        
    - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.ALIYUN_HOST }}"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi
